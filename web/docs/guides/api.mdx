---
id: api
<<<<<<< HEAD
title: API
description: APIの自動生成とリアルタイムAPI
=======
title: APIs
description: Auto-generating and Realtime APIs.
sidebar_label: Overview
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

## 概要

Supabaseはデータベースのスキーマから直接3つのタイプのAPIを生成します。

<<<<<<< HEAD
- REST - レストフルなインターフェースでやりとり
- Realtime - データベースの更新をリッスン
- GraphQL - [ベータ版](https://supabase.com/blog/2021/12/03/pg-graphql)
=======
- REST - interact with your database through a restful interface.
- Realtime - listen to database changes.
- GraphQL - [in beta](https://supabase.com/blog/pg-graphql).
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

これらのAPIは次の特徴があります。

- **即時性と自動生成** <br />データベースを更新すると、その変更内容がAPIを通じてすぐアクセス可能になります。
- **ドキュメントの生成** <br />Supabaseは、データベースを変更した際、ダッシュボードに更新されたドキュメントを生成します。
- **セキュア** <br />APIはPostgreSQLの行単位セキュリティーと連動するように設定されており、APIゲートウェイの背後でキーによる認証が有効になっています。
- **高速** <br />基本的な読み込みのベンチマークでは、Firebaseと比較して300%以上の高速化を実現しています。APIはPostgres上の非常に薄い層であり、Postgresがほとんどの力仕事をします。
- **スケーラブル** <br />APIは数千の同時リクエストに対応しており、サーバレスの処理にも適しています。

### REST API {#rest-api-overview}

Supabaseは、[PostgREST](https://postgrest.org/)を用いたRESTfulなAPIを提供しています。これは、Postgresの上の非常に薄いAPI層です。
これは、CRUDのAPIに必要なすべてを提供します。

- 基本的なCRUD操作
- 深くネストされた結合により、1回のフェッチで複数のテーブルからデータを取得可能
- Potgresのビューと連動
- Postgresの関数と連動
- 行単位セキュリティー、ロール、およびGRANTなどの、Postgresのセキュリティモデルと連動

<iframe
  className="w-full video-with-border"
  width="640"
  height="480"
  src="https://www.youtube-nocookie.com/embed/rPAJJFdtPw0"
  frameBorder="1"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
  allowFullScreen
></iframe>

### GraphQL API {#graphql-api-overview}

:::note

GraphQLはベータ版であり、変更される可能性があります。2022年3月28日以降に作成されたセルフ・ホストでのセットアップとSupabaseプロジェクトでのみ利用可能です。 

:::

<<<<<<< HEAD
SupabaseのGraphQLは、GraphQLのためのオープンソースのPostgreSQL拡張である[pg_graphql](https://supabase.com/blog/2021/12/03/pg-graphql)を通じて機能します。 

### リアルタイムAPI
=======
GraphQL in Supabase works through [pg_graphql](https://supabase.com/blog/pg-graphql), an open source PostgreSQL extension for GraphQL. 

### Realtime API {#realtime-api-overview}
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

Supabaseは[Realtime](https://github.com/supabase/realtime)を使って、リアルタイムAPIを提供しています。これを利用して、データベースの変更をWebSocketで待ち受けることができます。
RealtimeはPostgreSQLに組み込まれた論理的なレプリケーションを利用しています。Postgresのパブリケーションを管理するだけで、リアルタイムAPIを管できますす。

## はじめに

すべてのAPIは、データベースのテーブルから自動作成されます。データベースにテーブルや関数を追加した後、提供されるAPIを使用できます。 

### APIルートの作成

APIルートは、Postgresのテーブル、ビュー、または関数を作成する際、自動的に作成されます。

<<<<<<< HEAD
最初のAPIルートを作成するために、`todos`というテーブル（いくつかユーザーのパブリックな情報を保存します）を作成しましょう。
これにより、`GET`、`POST`、`PATCH`、`DELETE`のリクエストを受け付けることができる、`todos`に対応したルートが作成されます。
=======
Let's create our first 
API route by creating a table called `todos` to store tasks. 
This creates a corresponding route `todos` which can accept `GET`, `POST`, `PATCH`, & `DELETE` requests.
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

<Tabs
  groupId="dashboard-or-sql"
  defaultValue="dashboard"
  values={[
    {label: 'Dashboard', value: 'dashboard'},
    {label: 'SQL', value: 'sql'},
  ]}>

<<<<<<< HEAD
```sh
1. 「Table Editor」セクションに移動します。
2. 「New Table」をクリックします。
3. 「todos」というテーブル名を入力します。
4. 「Save」をクリックします。
5. 「New Column」をクリックします。
6. 「task」というカラム名を入力し、タイプを「text」にします。
7. 「Sava」をクリックします。
```
=======
<TabItem value="dashboard">

1. Go to the [Table editor](https://app.supabase.com/project/_/editor) page in the Dashboard.
1. Click **New Table** and create a table with the name `todos`.
1. Click **Save**.
1. Click **New Column** and create a column with the name `task` and type `text`.
1. Click **Save**.
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

<video width="99%" muted playsInline controls="true">
<source src="/docs/videos/api/api-create-table-sm.mp4" type="video/mp4" muted playsInline />
</video>

</TabItem>
<TabItem value="sql">

```sql
-- タスクを格納する列を持つ「todos」というテーブルを作成します。

create table todos (
  id bigint generated by default as identity primary key,
  task text check (char_length(task) > 3)
);
```

</TabItem>
</Tabs>

### API URLとキー

Supabaseの各プロジェクトには、固有のAPI URLがあります。APIはAPIゲートウェイで保護されており、リクエストごとにAPIキーが必要となります。

<<<<<<< HEAD

```sh
1. 「Settings」セクションに移動します。
2. サイドバーの「API」をクリックします。
3. そのページ内で、API URLを探します。
4. そのページ内で、「anon」と「service_role」キーを探します。
```
=======
1. Go to the [Settings](https://app.supabase.com/project/_/settings/general) page in the Dashboard.
2. Click **API** in the sidebar.
3. Find your API `URL`, `anon`, and `service_role` keys on this page.
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

<video width="99%" muted playsInline controls="true">
<source src="/docs/videos/api/api-url-and-key.mp4" type="video/mp4" muted playsInline />
</video>

REST APIとGraphQL APIは、どちらも次のURLよりアクセスできます。 

- REST: `https://<project_ref>.supabase.co/rest/v1`
- GraphQL: `https://<project_ref>.supabase.co/graphql/v1`

これらのルートはどちらも`anon`キーが`apikey`ヘッダーを通して渡されることを必要があります。

#### APIキー

<<<<<<< HEAD

キーは、ダッシュボード内の、上記URLと同じ場所にあります。

鍵は2つ用意されています。
=======
You are provided with two keys:
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

- `anon`キーはブラウザのコンテキストで使用しても安全です。
- `service_role`キーはサーバー上でのみ使用します。このキーは行単位セキュリティーを回避できます。


<<<<<<< HEAD
### ドキュメントへのアクセス
=======
### Accessing the docs in the Dashboard
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

#### REST API {#rest-api-dashboard-docs}

<<<<<<< HEAD
Supabaseは、データベースの変更に応じてドキュメントを更新して、ダッシュボードに生成します。
最初のステップで作成した`todos`テーブルのドキュメントを見てみましょう。

<Tabs
defaultValue="UI"
values={[
  {label: 'UI', value: 'UI'}
]}>
<TabItem value="UI">

```sh
1. 「API」セクションに移動します。
2. 「Tables and Views」セクションで「todos」を探します。
3. タブを使用して、JavaScriptとcURLのドキュメントを切り替えます。
```
=======
Supabase generates documentation in the [Dashboard](https://app.supabase.com) which updates as you make database changes. 
Let's view the documentation for a `countries` table which we created in our database.

1. Go to the [API](https://app.supabase.com/project/_/api) page in the Dashboard.
2. Find the `countries` table under **Tables and Views** in the sidebar.
3. Switch between the JavaScript and the cURL docs using the tabs.
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

<video width="99%" muted playsInline controls="true">
<source src="/docs/videos/api/api-docs.mp4" type="video/mp4" muted playsInline />
</video>

#### GraphQL 

GraphQLエンドポイント（`https://<project_ref>.supabase.com/graphql/v1`）は、`apikey`ヘッダーを渡せるGraphiQL実装と互換性があります。
いくつかの推奨アプリケーションを次に紹介します。

- [paw.cloud](https://paw.cloud)
- [insomnia.rest](https://insomnia.rest)
- [postman.com/graphql](https://www.postman.com/graphql/)
- セルフホスティングのGraphiQL：GraphiQLはシンプルなHTMLファイルを通して提供できます。詳しくは[こちらのDiscussion](https://github.com/supabase/supabase/discussions/6144)を参照

## APIの利用


### REST API

HTTPリクエストを介してAPIを直接操作できますし、当社が提供するクライアント・ライブラリーを使用できます。

<!-- textlint-disable ja-technical-writing/sentence-length -->
それでは、最初のステップで作成した`todos`テーブルに、取得したAPI URL（`[SUPABASE_URL]`）とキー（`[SUPABASE_ANON_KEY]`）を使ってリクエストする方法を見てみましょう。
<!-- textlint-enable ja-technical-writing/sentence-length -->


<Tabs
  groupId="language"
  defaultValue="javascript"
  values={[
    {label: 'JavaScript', value: 'javascript'},
    {label: 'cURL', value: 'curl'},
  ]}>

<TabItem value="javascript">

```javascript
// JSクライアントを初期化
import { createClient } from '@supabase/supabase-js'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// リクエストを作成
let { data: todos, error } = await supabase
  .from('todos')
  .select('*')
```

</TabItem>
<TabItem value="curl">

```bash
# URLに/rest/v1/を追加して、テーブル名をルートとして使用
curl '[SUPABASE_URL]/rest/v1/todos' \
-H "apikey: [SUPABASE_ANON_KEY]" \
-H "Authorization: Bearer SUPABASE_ANON_KEY"
```

</TabItem>
</Tabs>

<!-- textlint-disable ja-technical-writing/max-comma -->
- JSリファレンス：[select()](/docs/reference/javascript/select),
[insert()](/docs/reference/javascript/insert),
[update()](/docs/reference/javascript/update),
[upsert()](/docs/reference/javascript/upsert),
[delete()](/docs/reference/javascript/delete),
[rpc()](/docs/reference/javascript/rpc)（Postgresの関数呼び出し）
<!-- textlint-enable ja-technical-writing/max-comma -->


### GraphQL API

:::note 

SQLスキーマからGraphQLスキーマを再構築するには、`select graphql.rebuild_schema();`を呼び出します。
SQLスキーマを変更した後は、必ずGraphQLスキーマを再構築するようにしてください。

:::

Supabase GraphQL APIでは、任意のGraphQLクライアントを使用できます。今回のGraphQLの例では、[urlql](https://formidable.com/open-source/urql/docs/)を使用することにします。 

<Tabs
  groupId="language"
  defaultValue="javascript"
  values={[
    {label: 'JavaScript', value: 'javascript'},
    {label: 'cURL', value: 'curl'},
  ]}>

<TabItem value="javascript">

```javascript
import { createClient, useQuery } from 'urql'

// Prepare API key and Authorization header
const headers = {
  apikey: <SUPABASE_ANON_KEY>,
  authorization: `Bearer: ${<SUPABASE_ANON_KEY}`>
}

// Create GraphQL client
// See: https://formidable.com/open-source/urql/docs/basics/react-preact/#setting-up-the-client
const client = createClient({
  url: '<SUPABASE_URL>/graphql/v1',
  fetchOptions: function createFetchOptions() { 
    return { headers }
  },
})

// Prepare our GraphQL query
const TodosQuery = `
  query {
    todosCollection {
      edges {
        node {
          id
          title
        }
      }
    }
  }
`

// Query for the data (React)
const [result, reexecuteQuery] = useQuery({
  query: TodosQuery,
})

// Read the result
const { data, fetching, error } = result
```
</TabItem>
<TabItem value="curl">

```bash
# Append /graphql/v1/ to your URL, and then use the table name as the route
curl --request POST '<SUPABASE_URL>/graphql/v1' \
-H 'apikey: <SUPABASE_ANON_KEY>' \
-H 'Authorization: Bearer <SUPABASE_ANON_KEY>' \
-d '{ "query":"{ todos(first: 3) { edges { node { id } } } }" }'
```


</TabItem>
</Tabs>


### リアルタイムの管理

デフォルトでは、データベースのリアルタイムは無効になっています。それでは、`todos`テーブルのリアルタイムを有効にしてみましょう。

<Tabs
  groupId="dashboard-or-sql"
  defaultValue="dashboard"
  values={[
    {label: 'Dashboard', value: 'dashboard'},
    {label: 'SQL', value: 'sql'},
  ]}>

<<<<<<< HEAD
```sh
1. 「Database」セクションに移動します。
2. サイドバーの「Replication」をクリックします。
3. Insert/Update/Deleteのトグルを切り替えることで、どのデータベース・イベントを送信するか制御します。
4. 「Source」をクリックしてテーブルを切り替えることで、どのテーブルの変更を反映するか制御できます。
```
=======
<TabItem value="dashboard">

1. Go to the [Database](https://app.supabase.com/project/_/database/tables) page in the Dashboard.
2. Click on **Replication** in the sidebar.
3. Control which database events are sent by toggling **Insert**, **Update**, and **Delete**.
4. Control which tables broadcast changes by selecting **Source** and toggling each table.
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

<video width="99%" muted playsInline controls="true">
<source src="/docs/videos/api/api-realtime.mp4" type="video/mp4" muted playsInline />
</video>

</TabItem>
<TabItem value="sql">

```sql
alter publication supabase_realtime add table todos;
```

</TabItem>
</Tabs>

<<<<<<< HEAD
これで、`todo`テーブルに挿入される新しいデータをリッスンできるようになりました。

<Tabs
defaultValue="Javascript"
values={[
  {label: 'Javascript', value: 'Javascript'}
]}>
<TabItem value="Javascript">
=======
From the client, we can listen to any new data that is inserted into the `todos` table:
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

```javascript
// Initialize the JS client
import { createClient } from '@supabase/supabase-js'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// Create a function to handle inserts
const handleInserts = (payload) => {
  console.log('Change received!', payload)
}

// Listen to inserts
const { data: todos, error } = await supabase
  .from('todos')
  .on('INSERT', handleInserts)
  .subscribe()
```

<<<<<<< HEAD
</TabItem>
</Tabs>

データベースの変更をリッスンするには、[subscribe()](/docs/reference/javascript/subscribe)を使用します。 
リアルタイムAPIは、PostgreSQLのレプリケーション機能を介して動作します。Postgresはデータベースの変更を、`supabase_realtime`と呼ばれる「パブリケーション」に送信します。
=======
Use [subscribe()](/docs/reference/javascript/subscribe) to listen to database changes. 
The Realtime API works through PostgreSQL's replication functionality. Postgres sends database changes to a [publication](/docs/guides/database/replication#publications)
called `supabase_realtime`, and by managing this publication you can control which data is broadcast.
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

## APIのセキュリティー


### ルートのセキュア化

<<<<<<< HEAD
APIは、Postgresの行単位セキュリティーと連動するように設計されています。Supabase [Auth](/docs/guides/auth)を使用すれば、ログインしたユーザーに基づいてデータを制限できます。
データへのアクセスを制御するには、[ポリシー](/docs/guides/auth#policies)を使用します。
Postgresでテーブルを作成すると、デフォルトでは行単位セキュリティー（RLS）が無効になっています。[RLSを有効にする](/docs/guides/api#securing-your-routes)ことでセキュリティーを確保してください。
=======

Your API is designed to work with Postgres Row Level Security (RLS). If you use Supabase [Auth](/docs/guides/auth), you can restrict data based on the logged-in user.
To control access to your data, you can use [Policies](/docs/guides/auth#policies).
When you create a table in Postgres, Row Level Security is disabled by default. To enable RLS:
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

<Tabs
  groupId="dashboard-or-sql"
  defaultValue="dashboard"
  values={[
    {label: 'Dashboard', value: 'dashboard'},
    {label: 'SQL', value: 'sql'},
  ]}>

<<<<<<< HEAD
```sh
1. 「Authentication」セクションに移動します。
2. サイドバーの「Policies」をクリックします。
3. 「Enable RLS」をクリックして、行単位セキュリティーを有効にします。
```
=======
<TabItem value="dashboard">

1. Go to the [Authentication](https://app.supabase.com/project/_/auth/users) page in the Dashboard.
2. Click on **Policies** in the sidebar.
3. Select **Enable RLS** to enable Row Level Security.
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

</TabItem>
<TabItem value="sql">

```sql
alter table todos enable row level security;
```

</TabItem>
</Tabs>

### `service_role`キー

Never expose the `service_role` key in a browser or anywhere where a user can see it. This Key is designed to bypass Row Level Security - so it should only be used on a private server.

<<<<<<< HEAD
ブラウザーやユーザーが見ることのできる場所に`service_role`キーを決して公開しないでください。このキーは行単位セキュリティーをバイパスするように設計されています。したがって、公開されていないサーバーでのみ使用するようにしてください。

[GitHubと提携](https://supabase.com/blog/2022/03/28/community-day#supabase-is-now-a-github-secret-scanning-partner)し、Supabaseの`service_role`キーが公開リポジトリーにプッシュされていないかスキャンします。
GitHubがservice_role権限のあるキーを検出すると、そのキーをSupbaseに転送します。Supabaseは自動的にそのキーを失効してお知らせします。それにより、データを悪質業者から保護します。
=======
We have [partnered with GitHub](https://github.blog/changelog/2022-03-28-supabase-is-now-a-github-secret-scanning-partner/) to scan for Supabase `service_role` keys pushed to public repositories.
If they detect any keys with service_role privileges being pushed to GitHub, they will forward the API key to us, so that we can automatically revoke the detected secrets and notify you, protecting your data against malicious actors.
>>>>>>> 9afe4aa63018e344cef44496522711fdd0bf893f

### 誤って削除や更新をしてしまわないための保護機能

新しいプロジェクトでは、デフォルトで、APIから来るすべてのクエリに対してPostgres拡張機能の[safeupdate](https://github.com/eradman/pg-safeupdate)が有効になっています。 
これにより、付随するフィルターが提供されていない場合に、`delete()`または`update()`が失敗することを保証します。
これを無効にするには、ダッシュボードのSQLエディターで以下のクエリを実行します。
```sql
select usename,useconfig from pg_shadow where usename = 'authenticator' ;
```

useconfig` に期待される値は次のとおりです。
```
["session_preload_libraries=supautils, safeupdate"]
```
