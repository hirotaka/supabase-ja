---
id: with-angular
<<<<<<< HEAD
title: "クイックスタート：Angular"
description: AngularアプリでSupabaseを使用する方法をご紹介します。
=======
title: "Quickstart: Angular"
description: Learn how to use Supabase in your Angular App.
sidebar_label: Angular
>>>>>>> 792139f8765b04b3c71e6f6ba41a7922fce10b5d
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

## イントロ

この例では、SupabaseとAngularを使って、シンプルなユーザー管理アプリを（ゼロから）構築する手順を紹介します。内容は以下のとおりです。

- Supabase [Database](/docs/guides/database)：ユーザーデータを保存するためのPostgresデータベースです。
- Supabase [Auth](/docs/guides/auth)：ユーザーはマジックリンクでサインインできます（パスワードは不要、メールのみ）。
- Supabase [Storage](/docs/guides/storage)：ユーザーは写真をアップロードできます。
- [行単位セキュリティー](/docs/guides/auth#row-level-security)：データは保護されており、個人が自分のデータにしかアクセスできないようになっています。
- インスタント[API](/docs/guides/api)：データベースのテーブルを作成すると、APIが自動的に生成されます。

このガイドの最後には、ユーザーがログインして基本的なプロフィール情報を更新できるアプリが完成します。

![Supabaseユーザー管理の例](/img/user-management-demo.png)

<!--

Clicking this button the application will:

- Launch and prepare the Postgres database in Supabase.
- Launch the app in Vercel.
- Fork the example into your own GitHub account.
- Prepare the deployed application with all the necessary environment variables.

If you want to do it yourself, let's get started! -->

### GitHub

どこかで行き詰ったら、[このリポジトリー](https://github.com/angular-supa/supabase-angular-user-management)を見てみましょう。

## プロジェクトのセットアップ

ビルドを開始する前に、データベースとAPIをセットアップします。Supabaseで新しいプロジェクトを立ち上げ、データベース内に「スキーマ」を作成するだけです。

### プロジェクトの作成

1. [app.supabase.com](https://app.supabase.com)にアクセスします。
1. 「New Project」をクリックします。
1. プロジェクトの詳細を入力します。
1. 新しいデータベースが起動するのを待ちます。


### データベース・スキーマの設定

これからデータベース・スキーマを設定します。SQLエディターの「User Management Starter」クイック・スターターを使用するか、下記のSQLをコピー/ペーストして自分で実行できます。

<Tabs
  defaultValue="dashboard"
  values={[
    {label: 'Dashboard', value: 'dashboard'},
    {label: 'SQL', value: 'sql'},
  ]}>
<TabItem value="dashboard">

<<<<<<< HEAD
```sh
1. 「SQL」セクションに移動します。
2. 「User Management Starter」をクリックします。
3. 「Run」をクリックします。
```
=======
1. Go to the [SQL Editor](https://app.supabase.com/project/_/sql) page in the Dashboard.
2. Click **User Management Starter**.
3. Click **Run**.
>>>>>>> 792139f8765b04b3c71e6f6ba41a7922fce10b5d

<video width="99%" muted playsInline controls="true">
    <source src="/docs/videos/sql-user-management-starter.mp4" type="video/mp4" muted playsInline />
</video>

</TabItem>
<TabItem value="sql">

```sql
-- パブリックで「profiles」テーブルを作成
create table profiles (
  id uuid references auth.users not null,
  updated_at timestamp with time zone,
  username text unique,
  avatar_url text,
  website text,

  primary key (id),
  unique(username),
  constraint username_length check (char_length(username) >= 3)
);

alter table profiles enable row level security;

create policy "Public profiles are viewable by everyone."
  on profiles for select
  using ( true );

create policy "Users can insert their own profile."
  on profiles for insert
  with check ( auth.uid() = id );

create policy "Users can update own profile."
  on profiles for update
  using ( auth.uid() = id );

-- リアルタイムをセットアップ
begin;
  drop publication if exists supabase_realtime;
  create publication supabase_realtime;
commit;
alter publication supabase_realtime add table profiles;

-- ストレージをセットアップ
insert into storage.buckets (id, name)
values ('avatars', 'avatars');

create policy "Avatar images are publicly accessible."
  on storage.objects for select
  using ( bucket_id = 'avatars' );

create policy "Anyone can upload an avatar."
  on storage.objects for insert
  with check ( bucket_id = 'avatars' );
```

</TabItem>
</Tabs>


### APIキーの取得

データベースのテーブルをいくつか作成したので、自動生成されたAPIを使ってデータを挿入する準備ができました。API設定からURLと`anon`キーを取得する必要があります。

<<<<<<< HEAD
<Tabs
defaultValue="UI"
values={[
  {label: 'UI', value: 'UI'}
]}>
<TabItem value="UI">

```sh
1. 「Settings」セクションに移動します。
2. サイドバーの「API」をリックします。
3. そのページでAPI URLを探します。
4. 「anon」と「service_role」キーを探します。
```
=======
1. Go to the [Settings](https://app.supabase.com/project/_/settings) page in the Dashboard.
2. Click **API** in the sidebar.
3. Find your API `URL`, `anon`, and `service_role` keys on this page.
>>>>>>> 792139f8765b04b3c71e6f6ba41a7922fce10b5d

<video width="99%" muted playsInline controls="true">
    <source src="/docs/videos/api/api-url-and-key.mp4" type="video/mp4" muted playsInline />
</video>

<<<<<<< HEAD
</TabItem>
</Tabs>

## アプリの構築
=======
## Building the App
>>>>>>> 792139f8765b04b3c71e6f6ba41a7922fce10b5d

それでは、Angularアプリを一から作ってみましょう。

### Angularアプリの初期化

[Angular CLI](https://angular.io/cli)を使って、`supabase-angular`というアプリを初期化します。

```bash
npx ng new supabase-angular --routing false --style css
cd supabase-angular
```

そして、唯一追加する必要がある依存関係の[supbase-js](https://github.com/supabase/supabase-js)をインストールしましょう。

```bash
npm install @supabase/supabase-js
```

最終的には、`environment.ts`ファイルに環境変数を保存します。
必要なのはAPIのURLと[先ほど](#apiキーを取得)コピーした`anon`キーだけです。
これらの変数はブラウザー上で公開されますが、データベースでは[行単位のセキュリティ](/docs/guides/auth#row-level-security)が有効になっているので、全く問題ありません。


```ts title="environment.ts"
export const environment = {
  production: false,
  supabaseUrl: "YOUR_SUPABASE_URL",
  supabaseKey: "YOUR_SUPABASE_KEY"
};
```

API認証ができたので、Supabaseクライアントを初期化します。そのため、Supabase APIと通信するための関数を実装するために、`ng g s supabase`で**SupabaseService**を作成しましょう。

```ts title="src/app/supabase.service.ts"
import { Injectable } from '@angular/core';
import {AuthChangeEvent, createClient, Session, SupabaseClient} from '@supabase/supabase-js';
import {environment} from "../environments/environment";

export interface Profile {
  username: string;
  website: string;
  avatar_url: string;
}

@Injectable({
  providedIn: 'root'
})
export class SupabaseService {
  private supabase: SupabaseClient;

  constructor() {
    this.supabase = createClient(environment.supabaseUrl, environment.supabaseKey);
  }

  get user() {
    return this.supabase.auth.user();
  }

  get session() {
    return this.supabase.auth.session();
  }

  get profile() {
    return this.supabase
      .from('profiles')
      .select(`username, website, avatar_url`)
      .eq('id', this.user?.id)
      .single();
  }

  authChanges(callback: (event: AuthChangeEvent, session: Session | null) => void) {
    return this.supabase.auth.onAuthStateChange(callback);
  }

  signIn(email: string) {
    return this.supabase.auth.signIn({email});
  }

  signOut() {
    return this.supabase.auth.signOut();
  }

  updateProfile(profile: Profile) {
    const update = {
      ...profile,
      id: this.user?.id,
      updated_at: new Date()
    }

    return this.supabase.from('profiles').upsert(update, {
      returning: 'minimal', // Don't return the value after inserting
    });
  }

  downLoadImage(path: string) {
    return this.supabase.storage.from('avatars').download(path);
  }

  uploadAvatar(filePath: string, file: File) {
    return this.supabase.storage
      .from('avatars')
      .upload(filePath, file);
  }
}

```

また、オプションとして、CSSファイルの`src/index.css`を更新して、アプリの外観を整えます。
[こちら](https://raw.githubusercontent.com/supabase/supabase/master/examples/react-user-management/src/index.css)にあるファイルを参照してください。

### ログイン・コンポーネントの設定

ログインとサインアップを管理するAngularコンポーネントを設定してみましょう。ここではマジック・リンクを使い、ユーザーはパスワードを使わずにメールでサインインできます。 Angular CLIコマンドの`ng g c auth`で**AuthComponent**を作成します。

```ts title="src/app/auth.component.ts"
import { Component } from '@angular/core';
import {SupabaseService} from "./supabase.service";

@Component({
  selector: 'app-auth',
  template: `
    <div class="row flex flex-center">
      <form class="col-6 form-widget">
        <h1 class="header">Supabase + Angular</h1>
        <p class="description">Sign in via magic link with your email below</p>
        <div>
          <input
            #input
            class="inputField"
            type="email"
            placeholder="Your email"
          />
        </div>
        <div>
          <button
            type="submit"
            (click)="handleLogin(input.value)"
          class="button block"
          [disabled]="loading"
          >
          {{loading ? 'Loading' : 'Send magic link'}}
          </button>
        </div>
      </form>
    </div>
  `,
})
export class AuthComponent {
  loading = false;

  constructor(private readonly supabase: SupabaseService) { }

  async handleLogin(input: string) {
    try {
      this.loading = true;
      await this.supabase.signIn(input);
      alert('Check your email for the login link!');
    } catch (error) {
      alert(error.error_description || error.message)
    } finally {
      this.loading = false;
    }
  }
}
```

### アカウントページ

ユーザーがサイン・インした後、プロフィールの詳細を編集したり、アカウントを管理したりできるようにします。
Angular CLIコマンドの`ng g c account`で**AccountComponent**を作成します。

```ts title="src/app/account.component.ts"
import {Component, Input, OnInit} from '@angular/core';
import {Profile, SupabaseService} from "./supabase.service";
import {Session} from "@supabase/supabase-js";

@Component({
  selector: 'app-account',
  template: `
    <div class="form-widget">
      <div>
        <label for="email">Email</label>
        <input id="email" type="text" [value]="session?.user?.email" disabled/>
      </div>
      <div>
        <label for="username">Name</label>
        <input
          #username
          id="username"
          type="text"
          [value]="profile?.username ?? ''"
        />
      </div>
      <div>
        <label for="website">Website</label>
        <input
          #website
          id="website"
          type="url"
          [value]="profile?.website ?? ''"
        />
      </div>

      <div>
        <button
          class="button block primary"
          (click)="updateProfile(username.value, website.value)"
          [disabled]="loading"
        >
          {{loading ? 'Loading ...' : 'Update'}}
        </button>
      </div>

      <div>
        <button class="button block" (click)="signOut()">
          Sign Out
        </button>
      </div>
    </div>
  `
})
export class AccountComponent implements OnInit {
  loading = false;
  profile: Profile | undefined;

  @Input() session: Session | undefined;

  constructor(private readonly supabase: SupabaseService) { }

  ngOnInit() {
    this.getProfile();
  }

  async getProfile() {
    try {
      this.loading = true;
      let {data: profile, error, status} = await this.supabase.profile;

      if (error && status !== 406) {
        throw error;
      }

      if (profile) {
        this.profile = profile;
      }
    } catch (error) {
      alert(error.message)
    } finally {
      this.loading = false;
    }
  }

  async updateProfile(username: string, website: string, avatar_url: string = '') {
    try {
      this.loading = true;
      await this.supabase.updateProfile({username, website, avatar_url});
    } catch (error) {
      alert(error.message);
    } finally {
      this.loading = false;
    }
  }

  async signOut() {
    await this.supabase.signOut();
  }
}
```



### ローンチ

すべてのコンポーネントがそろったところで、**AppComponent**を更新しましょう。

```ts title="src/app/app.component.ts"
import {Component, OnInit} from '@angular/core';
import {SupabaseService} from "./supabase.service";

@Component({
  selector: 'app-root',
  template: `
  <div class="container" style="padding: 50px 0 100px 0">
    <app-account *ngIf="session; else auth" [session]="session"></app-account>
    <ng-template #auth>
      <app-auth></app-auth>
    </ng-template>
  </div>
  `
})
export class AppComponent implements OnInit {
  session = this.supabase.session;

  constructor(private readonly supabase: SupabaseService) { }

  ngOnInit() {
    this.supabase.authChanges((_, session) => this.session = session);
  }
}
```

更新が完了したら、ターミナル・ウィンドウでこれを実行します。

```bash
npm run start
```

そして、ブラウザーで[localhost:4200](http://localhost:4200)を開くと、完成したアプリを見ることができます。


![Supabase Angular](/img/supabase-angular-demo.png)

## おまけ：プロフィール写真

Supabaseのプロジェクトには、写真や動画などの大容量ファイルを管理するための[ストレージ](/docs/guides/storage)が用意されています。

### アップロード・ウィジェットの作成

ユーザーがプロフィール写真をアップロードできるように、ユーザーのアバターを作成しましょう。
Angular CLIコマンド`ng g c avatar`で**AvatarComponent**を作成します。

```ts title="src/app/avatar.component.ts"
import {Component, EventEmitter, Input, Output} from '@angular/core';
import {SupabaseService} from "./supabase.service";
import {DomSanitizer, SafeResourceUrl} from "@angular/platform-browser";

@Component({
  selector: 'app-avatar',
  template: `
    <div>
      <img
        *ngIf="_avatarUrl"
        [src]="_avatarUrl"
        alt="Avatar"
        class="avatar image"
        style="height: 150px; width: 150px"
      ></div>
    <div *ngIf="!_avatarUrl" class="avatar no-image" style="height: 150px; width: 150px"></div>
    <div style="width: 150px">
      <label class="button primary block" for="single">
        {{uploading ? 'Uploading ...' : 'Upload'}}
      </label>
      <input
        style="visibility: hidden;position: absolute"
        type="file"
        id="single"
        accept="image/*"
        (change)="uploadAvatar($event)"
        [disabled]="uploading"
      />
    </div>
  `,
})
export class AvatarComponent {
  _avatarUrl: SafeResourceUrl | undefined;
  uploading = false;

  @Input()
  set avatarUrl(url: string | undefined) {
    if (url) {
      this.downloadImage(url);
    }
  };

  @Output() upload = new EventEmitter<string>();

  constructor(
    private readonly supabase: SupabaseService,
    private readonly dom: DomSanitizer
  ) { }

  async downloadImage(path: string) {
    try {
      const {data} = await this.supabase.downLoadImage(path);
       if (data instanceof Blob) {
        this._avatarUrl = this.dom.bypassSecurityTrustResourceUrl(
          URL.createObjectURL(data)
        );
      }
    } catch (error) {
      console.error('Error downloading image: ', error.message);
    }
  }

  async uploadAvatar(event: any) {
    try {
      this.uploading = true;
      if (!event.target.files || event.target.files.length === 0) {
        throw new Error('You must select an image to upload.');
      }

      const file = event.target.files[0];
      const fileExt = file.name.split('.').pop();
      const fileName = `${Math.random()}.${fileExt}`;
      const filePath = `${fileName}`;

      await this.supabase.uploadAvatar(filePath, file);
      this.upload.emit(filePath);
    } catch (error) {
      alert(error.message);
    } finally {
      this.uploading = false;
    }
  }
}
```


### 新しいウィジェットの追加

そして、このウィジェットを**AccountComponent** htmlテンプレートの上に追加します。

```ts title="src/app/account.component.ts"
template: `
<app-avatar
    [avatarUrl]="this.profile?.avatar_url"
    (upload)="updateProfile(username.value, website.value, $event)">
</app-avatar>

<!-- input fields -->
`
```

## 次のステップ

この段階で、完全に機能するアプリケーションが完成しました。

- 何か疑問がありましたら、[こちら](https://github.com/supabase/supabase/discussions)で質問してください
- サインイン：[app.supabase.com](https://app.supabase.com)
